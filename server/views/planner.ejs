<%- include('./partials/header.ejs'); %>
  <section class="edit-content">
    <div class="edit-content-container">
      <table>
      <%
        if(result.length > 0){
      %>
          <th>선교회</th>
          <th>월</th>
          <th>주</th>
          <th>주일 모임</th>
          <th>화요 모임</th>
          <th>활성화</th>
      <%
          for(let i=0;i<result.length;i++){
            let checkFlag = result[i].display == true ? 'checked' : ' ';
            let no = result[i].no;
      %>
            <tr>
              <td><%=result[i].grade%></td>
              <td><%=result[i].month%></td>
              <td><%=result[i].week%></td>
              <input type="hidden" id="no-<%=i%>" value='<%=no%>'>
              <td><input type="text" id="sunday-<%=no%>" value="<%=result[i].sundayContent%>"></td>
              <td><input type="text" id="tuesday-<%=no%>" value="<%=result[i].tuesdayContent%>"></td>
              <td><input type="checkbox" id="display-<%=no%>" <%=checkFlag%> ></td>
            </tr>
      <%
          }
        }
      %>
    </table>
    <button type="button" id="submit">저장</button>
    </div>
  </section>
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.5/jquery-ui.min.js'></script>
  <script src="https://kit.fontawesome.com/02656a2617.js"></script>
  <script src="/javascripts/assemble.js" charset="utf-8"></script>
  <script type="text/javascript">
    let msg = '<%=msg%>';
    if(msg !== '') {
      alert(msg);
      msg = '';
    }

    //for make new table. if there is no planner table
    let result = '<%=result%>';
    if(result === '0'){
      console.log(result);
      if(confirm('연간 행사표가 존재하지 않습니다. 새로 만드시겠습니까?')){
        location.replace('/planner/make');
      }
    }
    else{
      let length = '<%=result.length%>';
      let target = [];
      $('#submit').click(function(){
        for(let i=0;i<Number(length);i++){
          let no = $('#no-'+i).val();
          let row = {
            no : no,
            sunday : $('#sunday-' + no).val(),
            tuesday : $('#tuesday-' + no).val(),
            display : $('#display-'+ no).is(":checked") == true ? true : false,
          }
          target.push(row);
        }
        $.ajax({
          url: '/planner/save',
          type: 'PUT',
          contentType:'application/json',
          data: JSON.stringify(target),
          dataType:'json',
          success : function(result){
            if(result.result){
              alert('저장되었습니다.');
              location.replace('/');
            }else{
              alert('저장에 실패했습니다.');
            }
          }
        });
        target = []; //init
      });
    }
  </script>
</body>
</html>
